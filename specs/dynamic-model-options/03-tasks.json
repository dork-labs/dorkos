{
  "spec": "specs/dynamic-model-options/02-specification.md",
  "slug": "dynamic-model-options",
  "generatedAt": "2026-02-27T12:00:00Z",
  "mode": "full",
  "lastDecomposeDate": null,
  "tasks": [
    {
      "id": "1.1",
      "phase": 1,
      "phaseName": "Foundation",
      "subject": "dynamic-model-options [P1] Add ModelOptionSchema to shared schemas and Transport interface",
      "description": "Add the ModelOption Zod schema to the shared package and extend the Transport interface with a `getModels()` method.\n\n## 1. Shared Schema (`packages/shared/src/schemas.ts`)\n\nAdd after the `ServerConfig` block (~line 542):\n\n```typescript\n// === Model Options ===\n\nexport const ModelOptionSchema = z\n  .object({\n    value: z.string().openapi({ description: 'Model identifier (e.g. claude-opus-4-6)' }),\n    displayName: z.string().openapi({ description: 'Human-readable model name' }),\n    description: z.string().openapi({ description: 'Short model description' }),\n  })\n  .openapi('ModelOption');\n\nexport type ModelOption = z.infer<typeof ModelOptionSchema>;\n```\n\n## 2. Re-export from types (`packages/shared/src/types.ts`)\n\nAdd `ModelOption` to the re-exports so downstream consumers can `import type { ModelOption } from '@dorkos/shared/types'`.\n\n## 3. Transport Interface (`packages/shared/src/transport.ts`)\n\nAdd `ModelOption` to the import from `./types.js` and add the method after `getConfig()`:\n\n```typescript\n/** List available Claude models (dynamic from SDK, with defaults). */\ngetModels(): Promise<ModelOption[]>;\n```\n\n## 4. HttpTransport (`apps/client/src/layers/shared/lib/http-transport.ts`)\n\nFollowing the `getConfig()` pattern:\n\n```typescript\ngetModels(): Promise<ModelOption[]> {\n  return fetchJSON<{ models: ModelOption[] }>(this.baseUrl, '/models').then((r) => r.models);\n}\n```\n\n## 5. DirectTransport (`apps/client/src/layers/shared/lib/direct-transport.ts`)\n\nHardcoded fallback for Obsidian embedded mode:\n\n```typescript\nasync getModels(): Promise<ModelOption[]> {\n  return [\n    { value: 'claude-sonnet-4-5-20250929', displayName: 'Sonnet 4.5', description: 'Fast, intelligent model for everyday tasks' },\n    { value: 'claude-haiku-4-5-20251001', displayName: 'Haiku 4.5', description: 'Fastest, most compact model' },\n    { value: 'claude-opus-4-6', displayName: 'Opus 4.6', description: 'Most capable model for complex tasks' },\n  ];\n}\n```\n\n## 6. Mock Transport (`packages/test-utils/src/mock-factories.ts`)\n\nAdd before `...overrides`:\n\n```typescript\n// Models\ngetModels: vi.fn().mockResolvedValue([\n  { value: 'claude-sonnet-4-5-20250929', displayName: 'Sonnet 4.5', description: 'Fast model' },\n  { value: 'claude-opus-4-6', displayName: 'Opus 4.6', description: 'Capable model' },\n]),\n```\n\n## Acceptance Criteria\n\n- `ModelOptionSchema` validates objects with `value`, `displayName`, and `description` string fields\n- `ModelOption` type is importable from `@dorkos/shared/types`\n- `Transport` interface includes `getModels(): Promise<ModelOption[]>`\n- `HttpTransport.getModels()` calls `GET /models` and unwraps `{ models }` response\n- `DirectTransport.getModels()` returns hardcoded 3-model array\n- `createMockTransport()` includes `getModels` mock\n- `pnpm typecheck` passes with no errors",
      "activeForm": "Adding ModelOption schema and Transport interface method",
      "size": "medium",
      "priority": "high",
      "dependencies": [],
      "parallelWith": ["1.2"]
    },
    {
      "id": "1.2",
      "phase": 1,
      "phaseName": "Foundation",
      "subject": "dynamic-model-options [P1] Add model caching to AgentManager and GET /api/models route",
      "description": "Add in-memory model caching to AgentManager using the SDK's `supportedModels()` method, and create a new Express route to expose the cached models.\n\n## 1. AgentManager Caching (`apps/server/src/services/core/agent-manager.ts`)\n\nAdd imports and constants:\n\n```typescript\nimport type { ModelOption } from '@dorkos/shared/types';\n\nconst DEFAULT_MODELS: ModelOption[] = [\n  { value: 'claude-sonnet-4-5-20250929', displayName: 'Sonnet 4.5', description: 'Fast, intelligent model for everyday tasks' },\n  { value: 'claude-haiku-4-5-20251001', displayName: 'Haiku 4.5', description: 'Fastest, most compact model' },\n  { value: 'claude-opus-4-6', displayName: 'Opus 4.6', description: 'Most capable model for complex tasks' },\n];\n```\n\nAdd private field to the class:\n\n```typescript\nprivate cachedModels: ModelOption[] | null = null;\n```\n\nIn `sendMessage()`, after `session.activeQuery = agentQuery;`, add non-blocking model fetch:\n\n```typescript\nif (!this.cachedModels) {\n  agentQuery.supportedModels().then((models) => {\n    this.cachedModels = models.map((m) => ({\n      value: m.value,\n      displayName: m.displayName,\n      description: m.description,\n    }));\n    logger.debug('[sendMessage] cached supported models', { count: this.cachedModels.length });\n  }).catch((err) => {\n    logger.debug('[sendMessage] failed to fetch supported models', { err });\n  });\n}\n```\n\nAdd public method:\n\n```typescript\n/** Get available models — returns SDK-reported models if cached, otherwise defaults. */\nasync getSupportedModels(): Promise<ModelOption[]> {\n  return this.cachedModels ?? DEFAULT_MODELS;\n}\n```\n\n## 2. Express Route (`apps/server/src/routes/models.ts`)\n\nCreate new file following the simple GET pattern from `routes/config.ts`:\n\n```typescript\nimport { Router } from 'express';\nimport { agentManager } from '../services/core/agent-manager.js';\n\nconst router = Router();\n\n/** GET /api/models — list available Claude models. */\nrouter.get('/', async (_req, res) => {\n  const models = await agentManager.getSupportedModels();\n  res.json({ models });\n});\n\nexport default router;\n```\n\n## 3. Mount in app.ts (`apps/server/src/app.ts`)\n\nAdd alongside other route imports and mounts:\n\n```typescript\nimport modelRoutes from './routes/models.js';\n// ...\napp.use('/api/models', modelRoutes);\n```\n\n## 4. Tests (`apps/server/src/services/core/__tests__/agent-manager-models.test.ts`)\n\nWrite unit tests for the caching behavior:\n\n```typescript\nimport { describe, it, expect, vi, beforeEach } from 'vitest';\n\ndescribe('AgentManager.getSupportedModels', () => {\n  it('returns default models when no query has run', async () => {\n    // Create a fresh AgentManager instance\n    // Call getSupportedModels() without any prior sendMessage()\n    // Assert it returns exactly 3 models: Sonnet 4.5, Haiku 4.5, Opus 4.6\n    // Assert each model has value, displayName, and description fields\n  });\n\n  it('returns cached models after they are populated', async () => {\n    // Access the private cachedModels field via Object.assign or similar\n    // Set cachedModels to a custom array\n    // Call getSupportedModels()\n    // Assert it returns the custom array, not defaults\n  });\n});\n```\n\nNote: Testing the `sendMessage()` integration with `supportedModels()` is complex due to SDK mocking — the unit tests focus on the `getSupportedModels()` public method behavior (defaults vs cached).\n\n## Acceptance Criteria\n\n- `AgentManager` has a `cachedModels` private field initialized to `null`\n- `getSupportedModels()` returns `DEFAULT_MODELS` when cache is empty\n- `getSupportedModels()` returns cached models when cache is populated\n- `sendMessage()` calls `agentQuery.supportedModels()` non-blocking on first invocation only\n- Failed `supportedModels()` calls are caught and logged at debug level (no error thrown)\n- `GET /api/models` returns `{ models: ModelOption[] }` JSON response\n- Route is mounted at `/api/models` in app.ts\n- Tests pass: `pnpm vitest run apps/server/src/services/core/__tests__/agent-manager-models.test.ts`",
      "activeForm": "Adding model caching to AgentManager and creating GET /api/models route",
      "size": "medium",
      "priority": "high",
      "dependencies": [],
      "parallelWith": ["1.1"]
    },
    {
      "id": "1.3",
      "phase": 1,
      "phaseName": "Foundation",
      "subject": "dynamic-model-options [P1] Create useModels hook and update ModelItem with descriptions",
      "description": "Create the `useModels` TanStack Query hook in the session entity layer, then update `ModelItem` to consume dynamic models and display descriptions in the dropdown.\n\n## 1. useModels Hook (`apps/client/src/layers/entities/session/model/use-models.ts`)\n\nNew file following the `useGitStatus` pattern:\n\n```typescript\nimport { useQuery } from '@tanstack/react-query';\nimport { useTransport } from '@/layers/shared/model';\nimport type { ModelOption } from '@dorkos/shared/types';\n\n/** Fetch available models from the server. Long staleTime since models rarely change. */\nexport function useModels() {\n  const transport = useTransport();\n\n  return useQuery<ModelOption[]>({\n    queryKey: ['models'],\n    queryFn: () => transport.getModels(),\n    staleTime: 30 * 60 * 1000,\n  });\n}\n```\n\n## 2. Barrel Export (`apps/client/src/layers/entities/session/index.ts`)\n\nAdd to existing exports:\n\n```typescript\nexport { useModels } from './model/use-models';\n```\n\n## 3. Updated ModelItem (`apps/client/src/layers/features/status/ui/ModelItem.tsx`)\n\nComplete replacement of the file:\n\n```typescript\nimport { Bot } from 'lucide-react';\nimport {\n  ResponsiveDropdownMenu,\n  ResponsiveDropdownMenuTrigger,\n  ResponsiveDropdownMenuContent,\n  ResponsiveDropdownMenuLabel,\n  ResponsiveDropdownMenuRadioGroup,\n  ResponsiveDropdownMenuRadioItem,\n} from '@/layers/shared/ui';\nimport { useModels } from '@/layers/entities/session';\nimport type { ModelOption } from '@dorkos/shared/types';\n\nfunction getModelLabel(model: string, models: ModelOption[]): string {\n  const option = models.find((o) => o.value === model);\n  if (option) return option.displayName;\n  const match = model.match(/claude-(\\w+)-/);\n  return match ? match[1].charAt(0).toUpperCase() + match[1].slice(1) : model;\n}\n\ninterface ModelItemProps {\n  model: string;\n  onChangeModel: (model: string) => void;\n}\n\nexport function ModelItem({ model, onChangeModel }: ModelItemProps) {\n  const { data: models = [] } = useModels();\n\n  return (\n    <ResponsiveDropdownMenu>\n      <ResponsiveDropdownMenuTrigger asChild>\n        <button className=\"hover:text-foreground inline-flex items-center gap-1 transition-colors duration-150\">\n          <Bot className=\"size-(--size-icon-xs)\" />\n          <span>{getModelLabel(model, models)}</span>\n        </button>\n      </ResponsiveDropdownMenuTrigger>\n      <ResponsiveDropdownMenuContent side=\"top\" align=\"start\" className=\"w-56\">\n        <ResponsiveDropdownMenuLabel>Model</ResponsiveDropdownMenuLabel>\n        <ResponsiveDropdownMenuRadioGroup value={model} onValueChange={onChangeModel}>\n          {models.map((m) => (\n            <ResponsiveDropdownMenuRadioItem key={m.value} value={m.value}>\n              <div>\n                <div>{m.displayName}</div>\n                <div className=\"text-muted-foreground text-[10px] leading-tight\">\n                  {m.description}\n                </div>\n              </div>\n            </ResponsiveDropdownMenuRadioItem>\n          ))}\n        </ResponsiveDropdownMenuRadioGroup>\n      </ResponsiveDropdownMenuContent>\n    </ResponsiveDropdownMenu>\n  );\n}\n```\n\nKey changes from the current `ModelItem.tsx`:\n- Remove hardcoded `MODEL_OPTIONS` array\n- Import `useModels` from `@/layers/entities/session`\n- Import `ModelOption` type from `@dorkos/shared/types`\n- `getModelLabel()` now takes `models` array as second parameter\n- Dropdown widened from `w-44` to `w-56` to fit descriptions\n- Each radio item shows `displayName` on first line and `description` on second line in `text-muted-foreground text-[10px] leading-tight`\n\n## 4. Tests\n\n### useModels Hook Test (`apps/client/src/layers/entities/session/__tests__/use-models.test.tsx`)\n\n```typescript\n/**\n * @vitest-environment jsdom\n */\nimport { describe, it, expect, vi } from 'vitest';\nimport { renderHook, waitFor } from '@testing-library/react';\nimport { QueryClient, QueryClientProvider } from '@tanstack/react-query';\nimport { TransportProvider } from '@/layers/shared/model';\nimport { createMockTransport } from '@dorkos/test-utils';\nimport { useModels } from '../model/use-models';\n\nconst mockModels = [\n  { value: 'claude-sonnet-4-5-20250929', displayName: 'Sonnet 4.5', description: 'Fast model' },\n  { value: 'claude-opus-4-6', displayName: 'Opus 4.6', description: 'Capable model' },\n];\n\ndescribe('useModels', () => {\n  it('returns model options from transport', async () => {\n    const transport = createMockTransport({ getModels: vi.fn().mockResolvedValue(mockModels) });\n    const queryClient = new QueryClient({ defaultOptions: { queries: { retry: false } } });\n\n    function Wrapper({ children }: { children: React.ReactNode }) {\n      return (\n        <QueryClientProvider client={queryClient}>\n          <TransportProvider transport={transport}>{children}</TransportProvider>\n        </QueryClientProvider>\n      );\n    }\n\n    const { result } = renderHook(() => useModels(), { wrapper: Wrapper });\n\n    await waitFor(() => {\n      expect(result.current.data).toEqual(mockModels);\n    });\n\n    expect(transport.getModels).toHaveBeenCalledOnce();\n  });\n});\n```\n\n### ModelItem Component Test (`apps/client/src/layers/features/status/__tests__/ModelItem.test.tsx`)\n\n```typescript\n/**\n * @vitest-environment jsdom\n */\nimport { describe, it, expect, vi } from 'vitest';\nimport { render, screen } from '@testing-library/react';\nimport '@testing-library/jest-dom';\nimport { QueryClient, QueryClientProvider } from '@tanstack/react-query';\nimport { TransportProvider } from '@/layers/shared/model';\nimport { createMockTransport } from '@dorkos/test-utils';\nimport { ModelItem } from '../ui/ModelItem';\n\nvi.mock('motion/react', () => ({\n  motion: new Proxy({}, { get: (_, tag) => tag }),\n  AnimatePresence: ({ children }: { children: React.ReactNode }) => children,\n}));\n\nconst mockModels = [\n  { value: 'claude-sonnet-4-5-20250929', displayName: 'Sonnet 4.5', description: 'Fast model' },\n  { value: 'claude-opus-4-6', displayName: 'Opus 4.6', description: 'Capable model' },\n];\n\nfunction createWrapper() {\n  const transport = createMockTransport({ getModels: vi.fn().mockResolvedValue(mockModels) });\n  const queryClient = new QueryClient({ defaultOptions: { queries: { retry: false } } });\n\n  return function Wrapper({ children }: { children: React.ReactNode }) {\n    return (\n      <QueryClientProvider client={queryClient}>\n        <TransportProvider transport={transport}>{children}</TransportProvider>\n      </QueryClientProvider>\n    );\n  };\n}\n\ndescribe('ModelItem', () => {\n  it('renders the current model display name', async () => {\n    render(\n      <ModelItem model=\"claude-opus-4-6\" onChangeModel={vi.fn()} />,\n      { wrapper: createWrapper() }\n    );\n    // The button text should show the display name from the models list\n    expect(await screen.findByText('Opus 4.6')).toBeInTheDocument();\n  });\n\n  it('falls back to extracted name for unknown models', () => {\n    render(\n      <ModelItem model=\"claude-unknown-1-0-20260101\" onChangeModel={vi.fn()} />,\n      { wrapper: createWrapper() }\n    );\n    // getModelLabel extracts \"Unknown\" from \"claude-unknown-1-0-20260101\" when not in models list\n    expect(screen.getByText('Unknown')).toBeInTheDocument();\n  });\n});\n```\n\n## Acceptance Criteria\n\n- `useModels()` hook returns `ModelOption[]` from transport with 30-minute staleTime\n- `useModels` is exported from `@/layers/entities/session` barrel\n- `ModelItem` no longer contains hardcoded `MODEL_OPTIONS`\n- `ModelItem` renders `displayName` and `description` for each model in the dropdown\n- `getModelLabel()` falls back to regex extraction for unknown model IDs\n- Dropdown width is `w-56` (wider than previous `w-44`)\n- Hook test passes: `pnpm vitest run apps/client/src/layers/entities/session/__tests__/use-models.test.tsx`\n- Component test passes: `pnpm vitest run apps/client/src/layers/features/status/__tests__/ModelItem.test.tsx`\n- FSD layer rules are respected: entities import from shared only, features import from entities and shared",
      "activeForm": "Creating useModels hook and updating ModelItem with dynamic model descriptions",
      "size": "medium",
      "priority": "high",
      "dependencies": ["1.1", "1.2"],
      "parallelWith": []
    },
    {
      "id": "1.4",
      "phase": 1,
      "phaseName": "Foundation",
      "subject": "dynamic-model-options [P1] Register ModelOption in OpenAPI spec and verify end-to-end",
      "description": "Register the ModelOption schema and GET /api/models endpoint in the OpenAPI registry, then verify the full data flow works end-to-end.\n\n## 1. OpenAPI Registration (`apps/server/src/services/openapi-registry.ts`)\n\nRegister the ModelOption schema and GET /api/models endpoint following existing patterns in the file. Add the schema registration:\n\n```typescript\nimport { ModelOptionSchema } from '@dorkos/shared/schemas';\n```\n\nRegister the endpoint (following the pattern of other GET endpoints like `/api/config`):\n\n```typescript\nregistry.registerPath({\n  method: 'get',\n  path: '/api/models',\n  summary: 'List available Claude models',\n  description: 'Returns models available to the user. Serves SDK-reported models if cached, otherwise returns defaults.',\n  responses: {\n    200: {\n      description: 'List of available models',\n      content: {\n        'application/json': {\n          schema: z.object({ models: z.array(ModelOptionSchema) }),\n        },\n      },\n    },\n  },\n});\n```\n\n## 2. End-to-End Verification\n\nManual verification steps:\n\n1. Start the dev server: `pnpm dev`\n2. Open the client in browser\n3. Verify the model dropdown in the status bar shows models (initially defaults: Sonnet 4.5, Haiku 4.5, Opus 4.6)\n4. Open dropdown — each model should show displayName on first line and description in small muted text below\n5. Select a different model — verify `onChangeModel` fires and selection updates\n6. Check `GET /api/models` in browser — should return `{ models: [...] }` JSON\n7. Check `/api/docs` — the ModelOption schema and `/api/models` endpoint should appear\n8. Send a message in a session — after the first message, `GET /api/models` should return SDK-reported models (may include additional models beyond the 3 defaults)\n\n## 3. Type Check and Lint\n\nRun full type check and lint to ensure no regressions:\n\n```bash\npnpm typecheck\npnpm lint\n```\n\n## Acceptance Criteria\n\n- ModelOption schema appears in OpenAPI spec at `/api/openapi.json`\n- GET /api/models endpoint is documented in `/api/docs` (Scalar UI)\n- `pnpm typecheck` passes with no errors across all packages\n- `pnpm lint` passes with no new warnings\n- All tests pass: `pnpm test -- --run`\n- Model dropdown renders correctly in the browser with descriptions visible",
      "activeForm": "Registering OpenAPI spec and verifying end-to-end integration",
      "size": "small",
      "priority": "medium",
      "dependencies": ["1.1", "1.2", "1.3"],
      "parallelWith": []
    }
  ]
}
