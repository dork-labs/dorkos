{
  "spec": "specs/env-var-discipline/02-specification.md",
  "slug": "env-var-discipline",
  "generatedAt": "2026-02-25T00:00:00.000Z",
  "mode": "full",
  "lastDecomposeDate": null,
  "tasks": [
    {
      "id": "1.1",
      "phase": 1,
      "phaseName": "Foundation",
      "subject": "[env-var-discipline] [P1] Create apps/server/src/env.ts with validated server environment schema",
      "description": "Create `apps/server/src/env.ts` with the following exact content:\n\n```ts\nimport { z } from 'zod';\n\n/** Reusable Zod type for 'true'/'false' env flags → boolean. */\nconst boolFlag = z.enum(['true', 'false']).default('false').transform(v => v === 'true');\n\nconst serverEnvSchema = z.object({\n  // Runtime\n  NODE_ENV: z.enum(['development', 'production', 'test']).default('development'),\n  DORKOS_PORT: z.coerce.number().int().min(1).max(65535).default(4242),\n  DORKOS_DEFAULT_CWD: z.string().optional(),\n  DORKOS_BOUNDARY: z.string().optional(),\n  DORKOS_LOG_LEVEL: z.coerce.number().int().min(0).max(5).optional(),\n  DORK_HOME: z.string().optional(),\n  DORKOS_VERSION: z.string().optional(),\n  CLIENT_DIST_PATH: z.string().optional(),\n  // Feature flags (boolean after transform)\n  DORKOS_PULSE_ENABLED: boolFlag,\n  DORKOS_RELAY_ENABLED: boolFlag,\n  DORKOS_MESH_ENABLED: boolFlag,\n  // Tunnel (ngrok integration — all optional)\n  TUNNEL_ENABLED: boolFlag,\n  TUNNEL_PORT: z.coerce.number().int().min(1).max(65535).optional(),\n  TUNNEL_AUTH: z.string().optional(),\n  TUNNEL_DOMAIN: z.string().optional(),\n  NGROK_AUTHTOKEN: z.string().optional(),\n});\n\nconst result = serverEnvSchema.safeParse(process.env);\n\nif (!result.success) {\n  console.error('\\n  Missing or invalid environment variables:\\n');\n  result.error.issues.forEach(i => console.error(`  - ${i.path.join('.')}: ${i.message}`));\n  console.error('\\n  Copy .env.example to .env\\n');\n  process.exit(1);\n}\n\nexport const env = result.data;\nexport type ServerEnv = typeof env;\n```\n\nKey design decisions:\n- `boolFlag` uses `z.enum(['true', 'false'])` NOT `z.coerce.boolean()` — coerce.boolean() would treat any non-empty string (including the string 'false') as true.\n- All fields have `.default()` or `.optional()` so the schema parses successfully in test environments with an empty process.env.\n- `DORKOS_PORT` uses `z.coerce.number()` to convert the string from process.env to a typed number.\n- `boolFlag` transform produces TypeScript `boolean`, eliminating all `=== 'true'` string comparisons downstream.\n\nAcceptance criteria:\n- File exists at `apps/server/src/env.ts`\n- `import { env } from './env'` from a sibling file resolves `env.DORKOS_PORT` as `number`\n- `import { env } from './env'` resolves `env.DORKOS_PULSE_ENABLED` as `boolean`\n- `pnpm typecheck` passes",
      "activeForm": "Creating apps/server/src/env.ts with Zod validation schema",
      "size": "small",
      "priority": "high",
      "dependencies": [],
      "parallelWith": ["1.2", "1.3", "1.4", "1.5"]
    },
    {
      "id": "1.2",
      "phase": 1,
      "phaseName": "Foundation",
      "subject": "[env-var-discipline] [P1] Create apps/client/src/env.ts with Vite built-in env stub",
      "description": "Create `apps/client/src/env.ts` with the following exact content:\n\n```ts\nimport { z } from 'zod';\n\n// DorkOS client currently has no custom VITE_* variables.\n// Vite's built-in env vars (MODE, DEV, PROD, SSR) are validated here.\n//\n// To add a validated client env var:\n//   1. Prefix the var name with VITE_ in .env.example\n//   2. Add it to clientEnvSchema below\n//   3. Add it to turbo.json build task env[]\n//   4. Access via: import { env } from '@/env'\nconst clientEnvSchema = z.object({\n  MODE: z.enum(['development', 'production', 'test']).default('development'),\n  DEV: z.boolean().default(false),\n});\n\nexport const env = clientEnvSchema.parse(import.meta.env);\nexport type ClientEnv = typeof env;\n```\n\nThis is a stub file — currently there are no custom `VITE_*` vars, only Vite built-ins (`import.meta.env.DEV`, `import.meta.env.MODE`). The file:\n1. Validates Vite built-ins with a Zod schema\n2. Establishes the canonical import path (`@/env`) for when `VITE_*` vars are added later\n3. Shows developers how to add `VITE_*` vars via comments\n\nNote: The client uses `import.meta.env` (not `process.env`) because Vite strips non-`VITE_*` vars from the browser bundle.\n\nAcceptance criteria:\n- File exists at `apps/client/src/env.ts`\n- `import { env } from '@/env'` resolves correctly from client source files\n- `pnpm typecheck` passes for the client package",
      "activeForm": "Creating apps/client/src/env.ts with Vite env stub",
      "size": "small",
      "priority": "high",
      "dependencies": [],
      "parallelWith": ["1.1", "1.3", "1.4", "1.5"]
    },
    {
      "id": "1.3",
      "phase": 1,
      "phaseName": "Foundation",
      "subject": "[env-var-discipline] [P1] Create apps/roadmap/src/server/env.ts with roadmap environment schema",
      "description": "Create `apps/roadmap/src/server/env.ts` with the following exact content:\n\n```ts\nimport { z } from 'zod';\n\nconst roadmapEnvSchema = z.object({\n  ROADMAP_PORT: z.coerce.number().int().min(1).max(65535).default(4243),\n  ROADMAP_PROJECT_ROOT: z.string().default(process.cwd()),\n  NODE_ENV: z.enum(['development', 'production', 'test']).default('development'),\n});\n\nconst result = roadmapEnvSchema.safeParse(process.env);\n\nif (!result.success) {\n  console.error('\\n  Roadmap: invalid environment variables:\\n');\n  result.error.issues.forEach(i => console.error(`  - ${i.path.join('.')}: ${i.message}`));\n  process.exit(1);\n}\n\nexport const env = result.data;\nexport type RoadmapEnv = typeof env;\n```\n\nThis file covers `ROADMAP_PORT` (currently accessed as `parseInt(process.env.ROADMAP_PORT ?? '4243', 10)`) and `ROADMAP_PROJECT_ROOT` (currently accessed as `process.env.ROADMAP_PROJECT_ROOT ?? process.cwd()`) in `apps/roadmap/src/server/index.ts`.\n\nAcceptance criteria:\n- File exists at `apps/roadmap/src/server/env.ts`\n- `env.ROADMAP_PORT` is typed as `number`\n- `pnpm typecheck` passes for the roadmap package",
      "activeForm": "Creating apps/roadmap/src/server/env.ts with schema",
      "size": "small",
      "priority": "high",
      "dependencies": [],
      "parallelWith": ["1.1", "1.2", "1.4", "1.5"]
    },
    {
      "id": "1.4",
      "phase": 1,
      "phaseName": "Foundation",
      "subject": "[env-var-discipline] [P1] Create apps/web/src/env.ts with Next.js marketing site env schema",
      "description": "Create `apps/web/src/env.ts` with the following exact content:\n\n```ts\nimport { z } from 'zod';\n\n// Next.js makes NEXT_PUBLIC_* vars available server-side and client-side.\n// Non-public vars are server-only.\nconst webEnvSchema = z.object({\n  NODE_ENV: z.enum(['development', 'production', 'test']).default('development'),\n  NEXT_PUBLIC_POSTHOG_KEY: z.string().optional(),\n  NEXT_PUBLIC_POSTHOG_HOST: z.string().url().default('https://app.posthog.com'),\n});\n\nexport const env = webEnvSchema.parse(process.env);\nexport type WebEnv = typeof env;\n```\n\nThis file covers the PostHog analytics integration used by `apps/web/src/lib/posthog-server.ts` and `apps/web/src/instrumentation-client.ts`. Both files currently access `process.env.NEXT_PUBLIC_POSTHOG_KEY` and `process.env.NEXT_PUBLIC_POSTHOG_HOST` directly.\n\nNote: T3 Env was explicitly rejected for Next.js (open bugs #155/#266/#323 with skipValidation + ESM-only constraint). Using manual Zod instead.\n\nAcceptance criteria:\n- File exists at `apps/web/src/env.ts`\n- `env.NEXT_PUBLIC_POSTHOG_KEY` is typed as `string | undefined`\n- `env.NEXT_PUBLIC_POSTHOG_HOST` is typed as `string` with default `'https://app.posthog.com'`\n- `pnpm typecheck` passes for the web package",
      "activeForm": "Creating apps/web/src/env.ts for Next.js marketing site",
      "size": "small",
      "priority": "high",
      "dependencies": [],
      "parallelWith": ["1.1", "1.2", "1.3", "1.5"]
    },
    {
      "id": "1.5",
      "phase": 1,
      "phaseName": "Foundation",
      "subject": "[env-var-discipline] [P1] Create packages/cli/src/env.ts with CLI read-only environment schema",
      "description": "Create `packages/cli/src/env.ts` with the following exact content:\n\n```ts\nimport { z } from 'zod';\n\n// Only vars the CLI itself reads (e.g., to display the current DORK_HOME).\n// The CLI imperatively sets DORKOS_PORT, TUNNEL_*, DORKOS_*_ENABLED, etc.\n// via process.env assignments in cli.ts to configure the server subprocess.\n// Those assignments remain in cli.ts with ESLint inline disables.\nconst cliEnvSchema = z.object({\n  NODE_ENV: z.enum(['development', 'production', 'test']).default('development'),\n  DORK_HOME: z.string().optional(),\n  LOG_LEVEL: z.string().optional(),\n});\n\nexport const env = cliEnvSchema.parse(process.env);\nexport type CliEnv = typeof env;\n```\n\nThe CLI has a special bootstrap role — it WRITES to `process.env` to configure the server subprocess before importing it. It cannot fully adopt `env.ts` for writes. This thin `env.ts` covers only what the CLI READS:\n- `DORK_HOME` — used to display current config storage directory\n- `LOG_LEVEL` — used to control CLI logging verbosity\n- `NODE_ENV` — for development/production mode detection\n\nThe imperative writes (`process.env.DORKOS_PORT = String(port)`, etc.) stay in `cli.ts` with inline ESLint disable comments (handled in task 2.4).\n\nAcceptance criteria:\n- File exists at `packages/cli/src/env.ts`\n- `env.DORK_HOME` is typed as `string | undefined`\n- `pnpm typecheck` passes for the CLI package",
      "activeForm": "Creating packages/cli/src/env.ts for CLI reads",
      "size": "small",
      "priority": "high",
      "dependencies": [],
      "parallelWith": ["1.1", "1.2", "1.3", "1.4"]
    },
    {
      "id": "1.6",
      "phase": 1,
      "phaseName": "Foundation",
      "subject": "[env-var-discipline] [P1] Add ESLint no-restricted-syntax rule and carve-outs to eslint.config.js",
      "description": "Modify `eslint.config.js` to add two new config blocks after the existing general rule overrides block (after the TSDoc enforcement block or the FSD layer enforcement blocks, before the test file overrides block — specifically after the last FSD enforcement block and before the test file overrides block at line ~197).\n\nAdd the following two config objects to the `tseslint.config(...)` array:\n\n```js\n// Env var discipline: no raw process.env access outside env.ts\n{\n  files: ['**/*.ts', '**/*.tsx'],\n  rules: {\n    'no-restricted-syntax': [\n      'warn', // warn-first per project convention; escalate to error once migration verified\n      {\n        selector: \"MemberExpression[object.name='process'][property.name='env']\",\n        message:\n          \"Import env vars from the app's env.ts instead of accessing process.env directly.\",\n      },\n    ],\n  },\n},\n\n// Carve-outs for files that legitimately access process.env\n{\n  files: [\n    '**/env.ts',             // env.ts files read process.env by design\n    '**/*.config.ts',        // vite.config.ts, playwright.config.ts run in Node before bundling\n    '**/__tests__/**',       // tests stub process.env for mocking\n    '**/*.test.ts',          // flat test files\n    '**/*.spec.ts',          // e2e spec files\n    'packages/cli/src/cli.ts', // CLI bootstrap sets env vars for server subprocess\n  ],\n  rules: { 'no-restricted-syntax': 'off' },\n},\n```\n\nIMPORTANT: The existing global `ignores` block matches `*.config.ts` at the repository root only (no `**/` prefix). Vite config files inside `apps/` are NOT currently in the global ignores. The carve-out uses `**/*.config.ts` to cover all config files in subdirectories.\n\nInsert these two blocks between the last FSD layer enforcement block (features/ cannot import widgets, ending around line 195) and the test file overrides block (starting around line 198). The result should look like:\n\n```js\n  // FSD Layer Enforcement: features/ cannot import widgets\n  { ... },\n\n  // Env var discipline: no raw process.env access outside env.ts\n  {\n    files: ['**/*.ts', '**/*.tsx'],\n    rules: { 'no-restricted-syntax': ['warn', { ... }] },\n  },\n\n  // Carve-outs for files that legitimately access process.env\n  {\n    files: ['**/env.ts', '**/*.config.ts', ...],\n    rules: { 'no-restricted-syntax': 'off' },\n  },\n\n  // Test file overrides — relax strict rules\n  { ... },\n```\n\nAcceptance criteria:\n- `pnpm lint` runs without crashing\n- A file with `process.env.FOO` that is NOT in a carve-out path produces a `no-restricted-syntax` warning\n- A file at `apps/server/src/env.ts` does NOT produce a warning for `process.env`\n- The existing FSD and test file overrides still apply",
      "activeForm": "Adding ESLint no-restricted-syntax rule and carve-outs",
      "size": "small",
      "priority": "high",
      "dependencies": ["1.1", "1.2", "1.3", "1.4", "1.5"],
      "parallelWith": ["1.7", "1.8", "1.9"]
    },
    {
      "id": "1.7",
      "phase": 1,
      "phaseName": "Foundation",
      "subject": "[env-var-discipline] [P1] Update .env.example with missing environment variables",
      "description": "Append the following missing variables to `apps/server/.env.example` or the root `.env.example` (whichever is the canonical one — the root `.env.example` based on project structure). The current `.env.example` is missing 8 vars. Add them after the existing `TUNNEL_PORT=4242` line:\n\n```bash\n# Relay messaging subsystem (disabled by default)\n# DORKOS_RELAY_ENABLED=true\n\n# Mesh agent discovery subsystem (disabled by default)\n# DORKOS_MESH_ENABLED=true\n\n# Version (injected at build time by the CLI package — do not set manually)\n# DORKOS_VERSION=\n\n# Client dev server port (Vite; proxies /api to DORKOS_PORT)\n# VITE_PORT=4241\n\n# Roadmap app (runs independently on a separate port)\n# ROADMAP_PORT=4243\n# ROADMAP_PROJECT_ROOT=\n\n# Analytics — apps/web marketing site only (optional)\n# NEXT_PUBLIC_POSTHOG_KEY=phc_...\n# NEXT_PUBLIC_POSTHOG_HOST=https://app.posthog.com\n```\n\nThe current `.env.example` (at repo root `/Users/doriancollier/Keep/dork-os/core/.env.example`) contains these vars:\n- DORKOS_PORT=4242\n- DORKOS_DEFAULT_CWD\n- DORKOS_BOUNDARY\n- DORKOS_LOG_LEVEL\n- DORK_HOME\n- DORKOS_PULSE_ENABLED\n- TUNNEL_ENABLED\n- NGROK_AUTHTOKEN\n- TUNNEL_AUTH\n- TUNNEL_DOMAIN\n- TUNNEL_PORT\n\nMissing (must be added):\n- DORKOS_RELAY_ENABLED\n- DORKOS_MESH_ENABLED\n- DORKOS_VERSION\n- VITE_PORT\n- ROADMAP_PORT\n- ROADMAP_PROJECT_ROOT\n- NEXT_PUBLIC_POSTHOG_KEY\n- NEXT_PUBLIC_POSTHOG_HOST\n\nAcceptance criteria:\n- All 8 missing vars are present in `.env.example` as commented-out examples\n- Each var has a descriptive inline comment explaining its purpose\n- The file remains valid shell syntax",
      "activeForm": "Updating .env.example with 8 missing variables",
      "size": "small",
      "priority": "medium",
      "dependencies": [],
      "parallelWith": ["1.6", "1.8", "1.9"]
    },
    {
      "id": "1.8",
      "phase": 1,
      "phaseName": "Foundation",
      "subject": "[env-var-discipline] [P1] Update turbo.json globalPassThroughEnv with missing runtime variables",
      "description": "Update `turbo.json` to add 4 missing vars to `globalPassThroughEnv`. The current `globalPassThroughEnv` array contains:\n```json\n[\n  \"DORKOS_PORT\",\n  \"DORKOS_DEFAULT_CWD\",\n  \"DORKOS_BOUNDARY\",\n  \"DORKOS_LOG_LEVEL\",\n  \"DORK_HOME\",\n  \"DORKOS_PULSE_ENABLED\",\n  \"DORKOS_RELAY_ENABLED\",\n  \"DORKOS_MESH_ENABLED\",\n  \"TUNNEL_ENABLED\",\n  \"TUNNEL_PORT\",\n  \"TUNNEL_AUTH\",\n  \"TUNNEL_DOMAIN\",\n  \"NGROK_AUTHTOKEN\",\n  \"VITE_PORT\"\n]\n```\n\nReplace with the complete list:\n```json\n\"globalPassThroughEnv\": [\n  \"DORKOS_PORT\",\n  \"DORKOS_DEFAULT_CWD\",\n  \"DORKOS_BOUNDARY\",\n  \"DORKOS_LOG_LEVEL\",\n  \"DORK_HOME\",\n  \"DORKOS_PULSE_ENABLED\",\n  \"DORKOS_RELAY_ENABLED\",\n  \"DORKOS_MESH_ENABLED\",\n  \"TUNNEL_ENABLED\",\n  \"TUNNEL_PORT\",\n  \"TUNNEL_AUTH\",\n  \"TUNNEL_DOMAIN\",\n  \"NGROK_AUTHTOKEN\",\n  \"VITE_PORT\",\n  \"ROADMAP_PORT\",\n  \"ROADMAP_PROJECT_ROOT\",\n  \"CLIENT_DIST_PATH\",\n  \"DORKOS_VERSION\"\n]\n```\n\nThe 4 vars being added:\n- `ROADMAP_PORT` — roadmap app server port\n- `ROADMAP_PROJECT_ROOT` — roadmap project root directory\n- `CLIENT_DIST_PATH` — path to built React client assets (set by CLI package)\n- `DORKOS_VERSION` — server version (injected at build time)\n\nThese belong in `globalPassThroughEnv` (not task `env`) because they are runtime vars that don't affect cache hash. Build-time vars like `NODE_ENV`, `VITE_*`, `NEXT_PUBLIC_*` are already in the task-level `env` arrays.\n\nAcceptance criteria:\n- `turbo.json` parses as valid JSON\n- All 4 new vars are present in `globalPassThroughEnv`\n- Existing vars remain unchanged",
      "activeForm": "Updating turbo.json globalPassThroughEnv with 4 missing vars",
      "size": "small",
      "priority": "medium",
      "dependencies": [],
      "parallelWith": ["1.6", "1.7", "1.9"]
    },
    {
      "id": "1.9",
      "phase": 1,
      "phaseName": "Foundation",
      "subject": "[env-var-discipline] [P1] Create contributing/environment-variables.md developer guide",
      "description": "Create `contributing/environment-variables.md` with a comprehensive developer guide. The file must cover all 8 required sections:\n\n## Required Sections\n\n### 1. The Pattern\nExplain why `env.ts` exists: silent runtime failures from `process.env` returning `undefined`, stringly-typed boolean feature flags checked with `=== 'true'` in 19+ files, and lack of discoverability. Each app/package exports a typed, validated `env` object that fails fast with actionable error messages.\n\n### 2. Where Each env.ts Lives\nTable:\n| App / Package | env.ts path | Env vars covered |\n|---|---|---|\n| `apps/server` | `apps/server/src/env.ts` | DORKOS_PORT, NODE_ENV, DORKOS_DEFAULT_CWD, DORKOS_BOUNDARY, DORKOS_LOG_LEVEL, DORK_HOME, DORKOS_VERSION, CLIENT_DIST_PATH, DORKOS_PULSE_ENABLED, DORKOS_RELAY_ENABLED, DORKOS_MESH_ENABLED, TUNNEL_ENABLED, TUNNEL_PORT, TUNNEL_AUTH, TUNNEL_DOMAIN, NGROK_AUTHTOKEN |\n| `apps/client` | `apps/client/src/env.ts` | MODE, DEV (Vite built-ins) |\n| `apps/roadmap` | `apps/roadmap/src/server/env.ts` | ROADMAP_PORT, ROADMAP_PROJECT_ROOT, NODE_ENV |\n| `apps/web` | `apps/web/src/env.ts` | NODE_ENV, NEXT_PUBLIC_POSTHOG_KEY, NEXT_PUBLIC_POSTHOG_HOST |\n| `packages/cli` | `packages/cli/src/env.ts` | NODE_ENV, DORK_HOME, LOG_LEVEL |\n\n### 3. How to Add a New Env Var\nStep-by-step checklist:\n1. Add to the relevant app's `env.ts` schema with type, default, and validation\n2. Add to `.env.example` with a comment explaining the var (use `# VAR=value` format for optional, `VAR=value` for required)\n3. Add to `turbo.json` `globalPassThroughEnv` if runtime var, or task-level `env` if build-time var\n4. Update the env var reference table in this document\n5. Access via `import { env } from './env'` (or `'@/env'` in the client)\n\n### 4. Boolean Feature Flags\nExplain the `boolFlag` helper and why `z.coerce.boolean()` is NOT used:\n```ts\nconst boolFlag = z.enum(['true', 'false']).default('false').transform(v => v === 'true');\n```\n- `z.coerce.boolean()` coerces ANY non-empty string to `true` — including the string `'false'`\n- `z.enum(['true', 'false'])` rejects typos like `'yes'`, `'1'`, `'enabled'` with a clear error\n- The `.transform()` produces TypeScript `boolean`, eliminating all `=== 'true'` comparisons\n\n### 5. ESLint Rule\nExplain the `no-restricted-syntax` rule targeting `MemberExpression[object.name='process'][property.name='env']`. List carve-out files:\n- `**/env.ts` — env.ts reads process.env by design\n- `**/*.config.ts` — vite.config.ts, playwright.config.ts run in Node before bundling\n- `**/__tests__/**` — tests stub process.env for mocking\n- `**/*.test.ts` and `**/*.spec.ts` — test files\n- `packages/cli/src/cli.ts` — CLI bootstrap writes env vars for server subprocess\n\nHow to add an inline disable for legitimate cases:\n```ts\n// eslint-disable-next-line no-restricted-syntax -- CLI bootstrap: sets env for server subprocess\nprocess.env.DORKOS_PORT = String(port);\n```\n\n### 6. Test Strategy\nAll schema fields have `.default()` or `.optional()`, so `env.ts` parses successfully with an empty `process.env`. Tests that need non-default values use:\n```ts\nbeforeEach(() => {\n  vi.resetModules();\n  vi.stubEnv('DORKOS_PORT', '9999');\n});\n\nafterEach(() => {\n  vi.unstubAllEnvs();\n});\n```\n`vi.stubEnv()` automatically restores the original value. `vi.resetModules()` forces `env.ts` to re-evaluate with the stubbed value.\n\n### 7. Vite Client Env Vars\nClient uses `import.meta.env` not `process.env`. Vite strips non-`VITE_*` vars from the browser bundle. To add a new VITE_* var:\n1. Name it with `VITE_` prefix in `.env.example`\n2. Add to `clientEnvSchema` in `apps/client/src/env.ts`\n3. Add to the `build` task's `env` array in `turbo.json` (not `globalPassThroughEnv` — build-time)\n4. Access via `import { env } from '@/env'`\n\n### 8. Complete Env Var Reference Table\nTable with all env vars: name, app, type, default, description. Include all vars from all 5 env.ts files.\n\nAcceptance criteria:\n- File exists at `contributing/environment-variables.md`\n- All 8 sections are present\n- The `boolFlag` explanation is accurate (explains why z.coerce.boolean() is dangerous)\n- The env var reference table includes all vars from all 5 env.ts files",
      "activeForm": "Writing contributing/environment-variables.md developer guide",
      "size": "medium",
      "priority": "medium",
      "dependencies": ["1.1", "1.2", "1.3", "1.4", "1.5"],
      "parallelWith": ["1.6", "1.7", "1.8"]
    },
    {
      "id": "2.1",
      "phase": 2,
      "phaseName": "Server Migration",
      "subject": "[env-var-discipline] [P2] Migrate apps/server/src/index.ts to use env.ts",
      "description": "Modify `apps/server/src/index.ts` to import from `./env.js` and replace all `process.env.*` reads. This file is the largest migration target — 12 vars.\n\nAdd import at the top (after existing imports):\n```ts\nimport { env } from './env.js';\n```\n\nReplace each of these:\n\n1. Line 27: `const PORT = parseInt(process.env.DORKOS_PORT || String(DEFAULT_PORT), 10);`\n   → `const PORT = env.DORKOS_PORT;`\n   (Remove the `DEFAULT_PORT` import from `@dorkos/shared/constants` if no longer used.)\n\n2. Lines 43-45:\n```ts\nconst logLevel = process.env.DORKOS_LOG_LEVEL\n  ? parseInt(process.env.DORKOS_LOG_LEVEL, 10)\n  : undefined;\n```\n→ `const logLevel = env.DORKOS_LOG_LEVEL;`\n\n3. Line 50: `const boundaryConfig = process.env.DORKOS_BOUNDARY || undefined;`\n   → `const boundaryConfig = env.DORKOS_BOUNDARY;`\n\n4. Line 61: `const pulseEnabled = process.env.DORKOS_PULSE_ENABLED === 'true' || schedulerConfig.enabled;`\n   → `const pulseEnabled = env.DORKOS_PULSE_ENABLED || schedulerConfig.enabled;`\n\n5. Line 71: `const relayEnabled = process.env.DORKOS_RELAY_ENABLED === 'true' || relayConfig?.enabled;`\n   → `const relayEnabled = env.DORKOS_RELAY_ENABLED || relayConfig?.enabled;`\n\n6. Line 99: `const meshEnabled = process.env.DORKOS_MESH_ENABLED === 'true' || meshConfig?.enabled;`\n   → `const meshEnabled = env.DORKOS_MESH_ENABLED || meshConfig?.enabled;`\n\n7. Line 125: `defaultCwd: process.env.DORKOS_DEFAULT_CWD ?? process.cwd(),`\n   → `defaultCwd: env.DORKOS_DEFAULT_CWD ?? process.cwd(),`\n\n8. Line 173: `const host = process.env.TUNNEL_ENABLED === 'true' ? '0.0.0.0' : 'localhost';`\n   → `const host = env.TUNNEL_ENABLED ? '0.0.0.0' : 'localhost';`\n\n9. Lines 193-194:\n```ts\nif (process.env.TUNNEL_ENABLED === 'true') {\n  const tunnelPort = parseInt(process.env.TUNNEL_PORT || String(PORT), 10);\n```\n→\n```ts\nif (env.TUNNEL_ENABLED) {\n  const tunnelPort = env.TUNNEL_PORT ?? PORT;\n```\n\n10. Line 199: `authtoken: process.env.NGROK_AUTHTOKEN,`\n    → `authtoken: env.NGROK_AUTHTOKEN,`\n\n11. Line 200: `basicAuth: process.env.TUNNEL_AUTH,`\n    → `basicAuth: env.TUNNEL_AUTH,`\n\n12. Line 201: `domain: process.env.TUNNEL_DOMAIN,`\n    → `domain: env.TUNNEL_DOMAIN,`\n\n13. Line 204: `const hasAuth = !!process.env.TUNNEL_AUTH;`\n    → `const hasAuth = !!env.TUNNEL_AUTH;`\n\nNote: Line 41 (`process.env.DORK_HOME = dorkHome;`) is a WRITE operation — keep it as-is. The server sets `DORK_HOME` after resolving it so downstream processes can inherit it. This is a legitimate write.\n\nAcceptance criteria:\n- No `process.env.*` reads remain in `apps/server/src/index.ts` (writes are allowed)\n- `pnpm typecheck` passes\n- `pnpm test` passes\n- Server starts successfully with `pnpm dev`",
      "activeForm": "Migrating apps/server/src/index.ts to use env object",
      "size": "medium",
      "priority": "high",
      "dependencies": ["1.1"],
      "parallelWith": ["2.2", "2.3"]
    },
    {
      "id": "2.2",
      "phase": 2,
      "phaseName": "Server Migration",
      "subject": "[env-var-discipline] [P2] Migrate apps/server/src/app.ts and lib files to use env.ts",
      "description": "Migrate 3 server files: `apps/server/src/app.ts`, `apps/server/src/lib/dork-home.ts`, and `apps/server/src/lib/logger.ts`.\n\n### apps/server/src/app.ts\n\nAdd import:\n```ts\nimport { env } from './env.js';\n```\n\nReplace:\n```ts\nif (process.env.NODE_ENV === 'production') {\n  const distPath = process.env.CLIENT_DIST_PATH ?? path.join(__dirname, '../../client/dist');\n```\nWith:\n```ts\nif (env.NODE_ENV === 'production') {\n  const distPath = env.CLIENT_DIST_PATH ?? path.join(__dirname, '../../client/dist');\n```\n\n### apps/server/src/lib/dork-home.ts\n\nThis file uses `DORK_HOME` and `NODE_ENV`. Read the current file content and replace all `process.env.DORK_HOME` and `process.env.NODE_ENV` reads with `env.DORK_HOME` and `env.NODE_ENV`. Add:\n```ts\nimport { env } from '../env.js';\n```\n\n### apps/server/src/lib/logger.ts\n\nThis file uses `NODE_ENV`. Read the current file and replace `process.env.NODE_ENV` with `env.NODE_ENV`. Add:\n```ts\nimport { env } from '../env.js';\n```\n\nAcceptance criteria:\n- No `process.env.*` reads remain in these 3 files\n- `pnpm typecheck` passes\n- `pnpm test` passes",
      "activeForm": "Migrating server app.ts, dork-home.ts, and logger.ts to env object",
      "size": "small",
      "priority": "high",
      "dependencies": ["1.1"],
      "parallelWith": ["2.1", "2.3"]
    },
    {
      "id": "2.3",
      "phase": 2,
      "phaseName": "Server Migration",
      "subject": "[env-var-discipline] [P2] Migrate apps/server/src/routes files to use env.ts",
      "description": "Migrate 3 server route files: `apps/server/src/routes/config.ts`, `apps/server/src/routes/tunnel.ts`, and `apps/server/src/routes/commands.ts`.\n\n### apps/server/src/routes/config.ts\n\nAdd import at top:\n```ts\nimport { env } from '../env.js';\n```\n\nLine 94 currently reads:\n```ts\nport: parseInt(process.env.DORKOS_PORT || String(DEFAULT_PORT), 10),\n```\nReplace with:\n```ts\nport: env.DORKOS_PORT,\n```\n(Remove the `DEFAULT_PORT` import from `@dorkos/shared/constants` if no longer used elsewhere in this file.)\n\nLine 104 currently reads:\n```ts\nauthEnabled: !!process.env.TUNNEL_AUTH,\ntokenConfigured: !!(process.env.NGROK_AUTHTOKEN || configManager.get('tunnel')?.authtoken),\n```\nReplace with:\n```ts\nauthEnabled: !!env.TUNNEL_AUTH,\ntokenConfigured: !!(env.NGROK_AUTHTOKEN || configManager.get('tunnel')?.authtoken),\n```\n\n### apps/server/src/routes/tunnel.ts\n\nRead the file and add `import { env } from '../env.js';`. Replace all `process.env.TUNNEL_PORT`, `process.env.NODE_ENV`, `process.env.DORKOS_PORT`, and `process.env.NGROK_AUTHTOKEN` reads with `env.TUNNEL_PORT`, `env.NODE_ENV`, `env.DORKOS_PORT`, and `env.NGROK_AUTHTOKEN`.\n\n### apps/server/src/routes/commands.ts\n\nRead the file and add `import { env } from '../env.js';`. Replace `process.env.DORKOS_DEFAULT_CWD` reads with `env.DORKOS_DEFAULT_CWD`.\n\nAcceptance criteria:\n- No `process.env.*` reads remain in these 3 files\n- `pnpm typecheck` passes\n- `pnpm test` passes (including `apps/server/src/routes/__tests__/config.test.ts`)",
      "activeForm": "Migrating server route files to use env object",
      "size": "small",
      "priority": "high",
      "dependencies": ["1.1"],
      "parallelWith": ["2.1", "2.2"]
    },
    {
      "id": "2.4",
      "phase": 2,
      "phaseName": "Server Migration",
      "subject": "[env-var-discipline] [P2] Migrate server service files (config-manager, context-builder, mcp-tool-server, agent-manager, pulse-store) to use env.ts",
      "description": "Migrate 5 server service files. All are in `apps/server/src/services/`.\n\n### src/services/core/config-manager.ts\n\nAdd import:\n```ts\nimport { env } from '../../env.js';\n```\nReplace `process.env.DORK_HOME` reads with `env.DORK_HOME`.\n\n### src/services/core/context-builder.ts\n\nAdd import:\n```ts\nimport { env } from '../../env.js';\n```\nReplace:\n- `process.env.DORKOS_VERSION` → `env.DORKOS_VERSION`\n- `process.env.DORKOS_PORT` → `env.DORKOS_PORT`\n\n### src/services/core/mcp-tool-server.ts\n\nAdd import:\n```ts\nimport { env } from '../../env.js';\n```\nReplace:\n- `process.env.DORKOS_PORT` → `env.DORKOS_PORT`\n- `process.env.DORKOS_VERSION` → `env.DORKOS_VERSION`\n\n### src/services/core/agent-manager.ts\n\nAdd import:\n```ts\nimport { env } from '../../env.js';\n```\nReplace `process.env.DORKOS_DEFAULT_CWD` reads with `env.DORKOS_DEFAULT_CWD`.\n\n### src/services/pulse/pulse-store.ts\n\nAdd import:\n```ts\nimport { env } from '../../env.js';\n```\nReplace `process.env.DORK_HOME` reads with `env.DORK_HOME`.\n\nFor all files: read each file first to understand the current usage, then make the targeted replacements. Do not modify any `process.env` WRITES (e.g., in test setup or bootstrap code).\n\nAcceptance criteria:\n- No `process.env.*` reads remain in these 5 files\n- `pnpm typecheck` passes\n- `pnpm test` passes",
      "activeForm": "Migrating server service files to use env object",
      "size": "medium",
      "priority": "high",
      "dependencies": ["1.1"],
      "parallelWith": []
    },
    {
      "id": "2.5",
      "phase": 2,
      "phaseName": "Server Migration",
      "subject": "[env-var-discipline] [P2] Migrate apps/roadmap/src/server/index.ts to use env.ts",
      "description": "Modify `apps/roadmap/src/server/index.ts` to import from `./env.js` and replace all `process.env.*` reads.\n\nAdd import:\n```ts\nimport { env } from './env.js';\n```\n\nReplace:\n```ts\nconst port = parseInt(process.env.ROADMAP_PORT ?? '4243', 10);\n```\nWith:\n```ts\nconst port = env.ROADMAP_PORT;\n```\n\nReplace:\n```ts\nconst projectRoot = process.env.ROADMAP_PROJECT_ROOT ?? process.cwd();\n```\nWith:\n```ts\nconst projectRoot = env.ROADMAP_PROJECT_ROOT;\n```\n\nRead the current file first to identify all `process.env.*` accesses before making changes.\n\nAcceptance criteria:\n- No `process.env.*` reads remain in `apps/roadmap/src/server/index.ts`\n- `pnpm typecheck` passes for the roadmap package\n- `pnpm test` passes",
      "activeForm": "Migrating roadmap server index.ts to use env object",
      "size": "small",
      "priority": "medium",
      "dependencies": ["1.3"],
      "parallelWith": ["2.6", "2.7"]
    },
    {
      "id": "2.6",
      "phase": 2,
      "phaseName": "Server Migration",
      "subject": "[env-var-discipline] [P2] Migrate apps/web PostHog files to use env.ts",
      "description": "Migrate 2 web app files: `apps/web/src/lib/posthog-server.ts` and `apps/web/src/instrumentation-client.ts` (or similar PostHog client file — read the directory to confirm exact filenames).\n\nFor both files, add the import:\n```ts\nimport { env } from '../env'; // or adjust relative path based on file location\n```\n\nIn `posthog-server.ts`, replace:\n- `process.env.NEXT_PUBLIC_POSTHOG_KEY` → `env.NEXT_PUBLIC_POSTHOG_KEY`\n- `process.env.NEXT_PUBLIC_POSTHOG_HOST` → `env.NEXT_PUBLIC_POSTHOG_HOST`\n\nIn `instrumentation-client.ts`, replace:\n- `process.env.NEXT_PUBLIC_POSTHOG_KEY` → `env.NEXT_PUBLIC_POSTHOG_KEY`\n- `process.env.NEXT_PUBLIC_POSTHOG_HOST` → `env.NEXT_PUBLIC_POSTHOG_HOST`\n\nRead each file first to confirm the current `process.env` usage before making changes. Adjust the relative import path (`'../env'` vs `'../../env'`) based on each file's location relative to `apps/web/src/env.ts`.\n\nAcceptance criteria:\n- No `process.env.NEXT_PUBLIC_POSTHOG_*` reads remain in these files\n- `pnpm typecheck` passes for the web package",
      "activeForm": "Migrating web PostHog files to use env object",
      "size": "small",
      "priority": "medium",
      "dependencies": ["1.4"],
      "parallelWith": ["2.5", "2.7"]
    },
    {
      "id": "2.7",
      "phase": 2,
      "phaseName": "Server Migration",
      "subject": "[env-var-discipline] [P2] Partially migrate packages/cli/src/cli.ts — reads to env.ts, writes get inline ESLint disables",
      "description": "Modify `packages/cli/src/cli.ts` with a split migration: reads go to `env.ts`, imperative writes get inline ESLint disable comments.\n\nAdd import at top:\n```ts\nimport { env } from './env.js';\n```\n\nRead the file first to identify all `process.env.*` accesses. Then:\n\n**Replace reads** (replace direct process.env reads with env.* equivalents):\n- `process.env.DORK_HOME` → `env.DORK_HOME`\n- `process.env.LOG_LEVEL` → `env.LOG_LEVEL`\n- `process.env.NODE_ENV` → `env.NODE_ENV`\n\n**Keep writes with inline ESLint disables** — for each imperative `process.env.FOO = ...` assignment, add a disable comment on the preceding line:\n```ts\n// eslint-disable-next-line no-restricted-syntax -- CLI bootstrap: sets env for server subprocess\nprocess.env.DORKOS_PORT = String(port);\n// eslint-disable-next-line no-restricted-syntax -- CLI bootstrap: sets env for server subprocess\nprocess.env.TUNNEL_ENABLED = String(tunnelEnabled);\n// eslint-disable-next-line no-restricted-syntax -- CLI bootstrap: sets env for server subprocess\nprocess.env.DORKOS_PULSE_ENABLED = String(pulseEnabled);\n// (repeat pattern for each assignment — read file to find all)\n```\n\nThe CLI is explicitly in the ESLint carve-out file (`packages/cli/src/cli.ts`), so technically the inline disables are redundant but serve as documentation explaining WHY these writes are intentional.\n\nAcceptance criteria:\n- All `process.env.*` reads in `cli.ts` are replaced with `env.*` equivalents\n- All `process.env.*` writes have inline ESLint disable comments\n- `pnpm typecheck` passes for the CLI package\n- `pnpm test` passes\n- `pnpm --filter=dorkos run build` succeeds",
      "activeForm": "Partially migrating cli.ts — reads to env, writes with ESLint disables",
      "size": "small",
      "priority": "medium",
      "dependencies": ["1.5"],
      "parallelWith": ["2.5", "2.6"]
    },
    {
      "id": "3.1",
      "phase": 3,
      "phaseName": "Verification and Tests",
      "subject": "[env-var-discipline] [P3] Write unit tests for apps/server/src/env.ts",
      "description": "Create `apps/server/src/__tests__/env.test.ts` with the following exact content:\n\n```ts\n/**\n * @vitest-environment node\n */\nimport { describe, it, expect, vi, afterEach } from 'vitest';\n\ndescribe('serverEnv', () => {\n  afterEach(() => {\n    vi.unstubAllEnvs();\n    vi.resetModules();\n  });\n\n  it('uses default port when DORKOS_PORT is not set', async () => {\n    vi.stubEnv('DORKOS_PORT', '');\n    const { env } = await import('../env.js');\n    expect(typeof env.DORKOS_PORT).toBe('number');\n    expect(env.DORKOS_PORT).toBe(4242);\n  });\n\n  it('parses DORKOS_PORT as a number', async () => {\n    vi.stubEnv('DORKOS_PORT', '6942');\n    const { env } = await import('../env.js');\n    expect(env.DORKOS_PORT).toBe(6942);\n    expect(typeof env.DORKOS_PORT).toBe('number');\n  });\n\n  it('feature flags default to false', async () => {\n    const { env } = await import('../env.js');\n    expect(env.DORKOS_PULSE_ENABLED).toBe(false);\n    expect(env.DORKOS_RELAY_ENABLED).toBe(false);\n    expect(env.DORKOS_MESH_ENABLED).toBe(false);\n  });\n\n  it('feature flag \"true\" string becomes boolean true', async () => {\n    vi.stubEnv('DORKOS_PULSE_ENABLED', 'true');\n    const { env } = await import('../env.js');\n    expect(env.DORKOS_PULSE_ENABLED).toBe(true);\n  });\n\n  it('feature flag \"false\" string becomes boolean false', async () => {\n    vi.stubEnv('DORKOS_PULSE_ENABLED', 'false');\n    const { env } = await import('../env.js');\n    expect(env.DORKOS_PULSE_ENABLED).toBe(false);\n  });\n\n  it('rejects an out-of-range port', async () => {\n    const exitSpy = vi.spyOn(process, 'exit').mockImplementation(() => undefined as never);\n    const errorSpy = vi.spyOn(console, 'error').mockImplementation(() => undefined);\n    vi.stubEnv('DORKOS_PORT', '99999');\n    await import('../env.js');\n    expect(exitSpy).toHaveBeenCalledWith(1);\n    exitSpy.mockRestore();\n    errorSpy.mockRestore();\n  });\n});\n```\n\nKey patterns:\n- `@vitest-environment node` directive is required (not jsdom)\n- `afterEach` runs `vi.unstubAllEnvs()` + `vi.resetModules()` to ensure each test gets a fresh `env.ts` evaluation\n- Dynamic import (`await import('../env.js')`) is required to re-evaluate `env.ts` after stubbing\n- The out-of-range port test mocks `process.exit` to prevent the test process from exiting\n\nAcceptance criteria:\n- File exists at `apps/server/src/__tests__/env.test.ts`\n- All 6 tests pass: `pnpm vitest run apps/server/src/__tests__/env.test.ts`\n- Tests run in isolation (each test gets a fresh env.ts evaluation)",
      "activeForm": "Writing unit tests for server env.ts",
      "size": "medium",
      "priority": "high",
      "dependencies": ["1.1", "2.1", "2.2", "2.3", "2.4"],
      "parallelWith": ["3.2"]
    },
    {
      "id": "3.2",
      "phase": 3,
      "phaseName": "Verification and Tests",
      "subject": "[env-var-discipline] [P3] Run full verification — typecheck, tests, lint — and resolve any failures",
      "description": "Run the full verification suite to confirm the migration is complete and correct:\n\n```bash\n# Step 1: Type check all packages\npnpm typecheck\n\n# Step 2: Run all tests\npnpm test -- --run\n\n# Step 3: Run lint and check for residual process.env warnings\npnpm lint 2>&1 | grep \"no-restricted-syntax\"\n```\n\nExpected outcomes:\n- `pnpm typecheck` exits 0 with no type errors\n- `pnpm test` exits 0 with all tests passing (including the new `env.test.ts`)\n- `pnpm lint | grep no-restricted-syntax` returns zero results (or only results from files in the carve-out list: `**/env.ts`, `**/*.config.ts`, `**/__tests__/**`, `**/*.test.ts`, `**/*.spec.ts`, `packages/cli/src/cli.ts`)\n\nIf `pnpm lint` shows `no-restricted-syntax` warnings in non-carve-out files:\n- Identify which files still have `process.env.*` reads\n- Migrate them using the same pattern as Phase 2 tasks\n- Re-run verification\n\nIf `pnpm typecheck` fails:\n- Check that all import paths use `.js` extension (NodeNext module resolution)\n- Check that `env.*` property names match the schema field names exactly\n- Check that `env.ts` is in the correct directory relative to each importer\n\nIf `pnpm test` fails:\n- Check if any test file directly imports from a migrated file and expects `process.env.*` behavior\n- Test files are in the ESLint carve-out but should still access env vars via `vi.stubEnv()` patterns\n\nAcceptance criteria:\n- `pnpm typecheck` exits 0\n- `pnpm test` exits 0 (all tests pass)\n- `pnpm lint | grep no-restricted-syntax` returns zero results from non-carve-out files",
      "activeForm": "Running typecheck, tests, and lint verification",
      "size": "small",
      "priority": "high",
      "dependencies": ["2.1", "2.2", "2.3", "2.4", "2.5", "2.6", "2.7", "3.1"],
      "parallelWith": []
    }
  ]
}
